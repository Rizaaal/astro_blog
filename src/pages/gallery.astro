---
import Base from "../layouts/Base.astro";
import MainSection from "../layouts/MainSection.astro";
const posts = await Astro.glob("./posts/**/*.md");
const images = posts.map((post) => post.frontmatter.image);
import "../style.css";
---

<style>
  img {
    width: 50%;
  }
</style>

<Base>
  <MainSection title="Images from all posts" />

  <dialog class="modal">
    <img src="" alt="alt" />
    <h2>Title</h2>
    <p>
      <span class="tags">#tag</span>
    </p>
    <p id="description">description</p>
    <h3>License</h3>
    <!-- if license is not provided, show something else -->
    <p><small>license</small></p>
    <button><a href="#">Read article</a></button>
    <button><a href="#" target="_blank">View Image</a></button>
    <button id="close">close</button>
  </dialog>

  <ul>
    {
      images.map((image) => (
        <li>
          <img src={image.url} alt={image.alt} />
        </li>
      ))
    }
  </ul>
</Base>

<script>
  //@ts-nocheck
  import formatDate from "../utils/scripts/date.js";
  const dialog = document.querySelector("dialog");
  const images = document.querySelectorAll("li > img");
  const closeButton = document.querySelector("dialog > button#close");
  const posts = Object.values(import.meta.glob("./posts/**/*.md"));

  closeButton.addEventListener("click", () => dialog.close());

  Promise.all(posts.map((post) => post())).then((posts) => {
    images.forEach((image, i) =>
      image.addEventListener("click", () => {
        dialog.children[0].src = posts[i].frontmatter.image.url;
        dialog.children[1].innerText = posts[i].frontmatter.title;
        dialog.children[2].innerHTML = `
          ${formatDate.USADate(new Date(posts[i].frontmatter.pubDate))}
          ${posts[i].frontmatter.tags.reduce((string, tag) => {
            return `${string} #${tag} `;
          }, "")}`;
        dialog.children[3].innerText = posts[i].frontmatter.description;
        dialog.children[5].innerHTML = `
          <small>
            ${posts[i].frontmatter.image.license || "none"}
          </small>`;
        dialog.children[6].children[0].href = posts[i].url;
        dialog.children[7].children[0].href = posts[i].frontmatter.image.url;
        dialog.showModal();
      }),
    );
  });
</script>
